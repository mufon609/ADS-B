# ADS-B Aircraft Tracking and Optical Guiding System

## Project Description
This project implements an automated system for tracking aircraft using ADS-B data and an astronomical mount with a camera. It monitors real-time ADS-B broadcasts, predicts aircraft trajectories, intelligently selects targets based on an expected value model, and then uses optical guiding to precisely track the chosen aircraft. The system captures image sequences of the tracked aircraft and provides a web-based dashboard for real-time status monitoring and control.

## Features
- Real-time ADS-B data processing and flight path prediction.
- Intelligent target selection and queuing based on expected value.
- Automated telescope slewing and optical guiding.
- Image capture and stacking for enhanced signal-to-noise.
- Web dashboard for monitoring status, viewing targets, and issuing commands.
- Dry-run mode for development and testing without hardware.

## Setup

### 1. Install System Dependencies (ASTAP)
This project requires the ASTAP plate-solver for an optional (but highly recommended) camera calibration step.
*   Download and install the ASTAP program and a star catalog (e.g., H17 or D50) from [the official website](http://www.hnsky.org/astap.htm). Choose the versions for your operating system.

### 2. Install Python Dependencies
```bash
pip install -r requirements.txt
```

### 3. Update `config.yaml`
The `config.yaml` file is central to configuring the system. Key sections to review and update include:
*   `adsb.json_file_path`: Path to the `aircraft.json` file generated by your ADS-B receiver (or `fake_dump1090_1hz.py`).
*   `observer`: Your geographical coordinates (`latitude_deg`, `longitude_deg`, `altitude_m`).
*   `hardware`: INDI server details (`indi_host`, `indi_port`) and device names (`mount_device_name`, `camera_device_name`, `focuser_device_name`).
*   `camera_specs`: Camera resolution, pixel size, focal length, and optional settings like binning, gain, offset, and cooling.
*   `selection`: Parameters for target selection, such as `min_elevation_deg`, `min_sun_separation_deg`, `max_range_nm`, and `preempt_factor`.
*   `capture`: Settings for image capture, guiding, autofocus, and detection.
*   `pointing_calibration`: Values for `plate_scale_arcsec_px` and `rotation_angle_deg` obtained from camera calibration.

### 4. Calibrate Camera (One-Time, at Night)
This step determines your camera's precise plate scale and rotation.
*   Point your telescope at a clear, star-rich part of the night sky.
*   Ensure your INDI server is running.
*   Run the calibration script:
    ```bash
    python calibrate_camera.py
    ```
*   Copy the `plate_scale_arcsec_px` and `rotation_angle_deg` values from the script's output and paste them into the `pointing_calibration` section of your `config.yaml` file.

### 5. Calibrate Pointing (One-Time)
Perform a one-time physical test to determine the correct `az_offset_sign` and `el_offset_sign` values in the `pointing_calibration` section of `config.yaml`. This typically involves manually moving the mount and observing the camera's response.

## Running the Program

### 1. Start the ADS-B Data Feed
If you don't have a live ADS-B receiver feeding `aircraft.json`, you can use the provided simulator:
```bash
python fake_dump1090_1hz.py --out data/aircraft.json &
```
This will run in the background, continuously updating `data/aircraft.json` with simulated aircraft data.

### 2. Start the Main Tracker Application
```bash
python main.py &
```
This will start the core tracking logic in the background. It will read ADS-B data, control the mount, and capture images.

### 3. Start the Web Dashboard
```bash
uvicorn dashboard.server:app --reload --port 8000
```
Access the dashboard in your web browser at `http://localhost:8000` (or the port configured in `config.yaml`).

## Dashboard
The web dashboard provides a real-time interface to the system:
*   **Status:** View the current operational mode, active track, and hardware status.
*   **Target Queue:** See a list of potential aircraft targets and their expected values.
*   **Image Previews:** View the latest guide frames and captured image sequences.
*   **Commands:** Manually select an aircraft to track, abort the current track, or park the mount.

## Development

### Dry-Run Mode
The system supports a `dry_run` mode for development and testing without requiring physical hardware. To enable it, set `development.dry_run: true` in your `config.yaml`. In this mode, hardware interactions are simulated, and image analysis functions return simulated results.

## Evaluation
After a tracking session, you can run `python evaluator.py` to analyze the accuracy of the dead reckoning predictions against the logged flight data. This script will output statistics on prediction errors.

## Troubleshooting

### `main.py` Exits Prematurely
*   **Check `config.yaml`:** Ensure all paths (especially `adsb.json_file_path`) and hardware settings are correct.
*   **ADS-B Feed:** Verify that `fake_dump1090_1hz.py` (or your actual ADS-B receiver) is running and actively writing to the `aircraft.json` file specified in `config.yaml`. `main.py` will exit if it cannot read valid ADS-B data.
*   **Hardware Initialization:** If not in `dry_run` mode, ensure your INDI server is running and all specified hardware devices are connected and accessible. Check the console output of `main.py` for hardware initialization errors.
*   **Console Output:** If `main.py` exits, try running it in the foreground (`python main.py`) without `&` to observe any error messages directly.

### `pip-audit` Not Found
If `pip-audit` is not found, install it using `pip install pip-audit`.
