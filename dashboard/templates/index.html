<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ADS-B Tracker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Use jsDelivr; unpkg sometimes serves text/plain -->
  <link href="https://cdn.jsdelivr.net/npm/missing.css@1.1.3/dist/missing.min.css" rel="stylesheet">
  <style>
    body { background: #222; color: #eee; }
    main { max-width: 1600px; }
    .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); }
    .imgbox { background:#111; padding:0.5rem; border-radius:8px; min-height: 180px; }
    .imgbox img { width:100%; height:auto; display:block; border-radius:4px; }
    .muted { opacity: 0.7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 0.9em; }
    dt { font-weight: bold; color: #aaa; float: left; width: 140px; clear: left; }
    dd { margin-left: 150px; padding-bottom: 0.2em;}
    dl { overflow: hidden; }
    button { padding: 0.25em 0.5em; margin: 0; }
    .controls { display: flex; gap: 0.5rem; margin-top: 1rem; }
    button.danger { background-color: #a42; border-color: #831; color: white; }
    button:disabled { background-color: #444; border-color: #333; }
    .status-idle { color: #8f8; }
    .status-tracking, .status-slewing, .status-focusing { color: #8df; }
    .status-acquiring { color: #fd8; }
    .tracking-row { background-color: #334; font-weight: bold; }

    /* Multi-variant stack panel */
    .stack-grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .stack-card h4 { margin: 0 0 .25rem 0; }
    .stack-links a { margin-right: .75rem; }
    .pill { display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#333; color:#ddd; font-size:.8em; }
    .sep { opacity:.5; margin:0 .25rem; }
  </style>
</head>
<body>
<header><h1>ADS-B Tracker Dashboard</h1></header>

<main>
<section class="grid">
  <article>
    <h3>System Status</h3>
    <dl class="mono">
      <dt>Mode</dt><dd id="statusText">Initializing...</dd>
      <dt>Target Coords</dt><dd id="targetCoords">—</dd>
      <dt>Mount Coords</dt><dd id="mountCoords">—</dd>
      <dt>Observer</dt><dd id="observerLocation">—</dd>
      <dt>Last Update</dt><dd id="updatedAt">—</dd>
    </dl>
    <div class="controls">
        <form action="/command/abort" method="post"><button type="submit" id="abortButton" class="danger" disabled>Abort Track</button></form>
        <form action="/command/park" method="post"><button type="submit">Park Mount</button></form>
    </div>
  </article>

  <article>
    <h3>Target Details</h3>
    <dl class="mono">
      <dt>ICAO</dt><dd id="targetIcao">—</dd>
      <dt>Flight</dt><dd id="targetFlight">—</dd>
      <dt>Altitude</dt><dd id="targetAlt">—</dd>
      <dt>Speed</dt><dd id="targetSpeed">—</dd>
      <dt>Track</dt><dd id="targetTrack">—</dd>
    </dl>
  </article>

  <article>
    <h3>Camera & Hardware Vitals</h3>
    <dl class="mono">
        <dt>Cooler Setpoint</dt><dd id="camSetpoint">—</dd>
        <dt>Camera Temp</dt><dd id="camTemp">—</dd>
        <dt>Cooler Power</dt><dd id="coolerPower">—</dd>
        <dt>Live Binning</dt><dd id="camBinning">—</dd>
        <dt>Live Gain</dt><dd id="camGain">—</dd>
        <dt>Live Offset</dt><dd id="camOffset">—</dd>
        <dt>Focuser Pos</dt><dd id="focuserPos">—</dd>
        <dt>Focuser Temp</dt><dd id="focuserTemp">—</dd>
        <dt>Mount Pier Side</dt><dd id="pierSide">—</dd>
    </dl>
  </article>

  <article>
    <h3>Latest Guide Image</h3>
    <div class="imgbox"><img id="guideImg" alt="Guide preview" style="display:none;"/></div>
    <div id="guideInfo" class="mono muted">—</div>
    <div class="mono">Offset: <span id="offsetXY">—</span></div>
    <!-- This text was part of the removed panel, moving it here -->
    <div class="mono muted" style="margin-top: 0.5rem;">
        Frames: <span id="sequenceCount">—</span> / Exp: <span id="sequenceExp">—</span>s
    </div>
  </article>

</section>

<!-- Latest multi-variant stacks -->
<section>
  <h2>Latest Stacks <span id="stackBadge" class="pill" style="display:none;"></span></h2>
  <div id="stackMeta" class="mono muted">No stacked sequences yet.</div>
  <div class="stack-grid">
    <article class="stack-card">
      <h4>Mean</h4>
      <div class="imgbox"><img id="stackMeanImg" alt="Mean stack" style="display:none;"></div>
      <div class="stack-links mono muted">
        <a id="meanPngLink" href="#" target="_blank" style="display:none;">PNG</a>
        <span class="sep">·</span>
        <a id="meanFitsLink" href="#" target="_blank" style="display:none;">FITS</a>
      </div>
    </article>
    <article class="stack-card">
      <h4>Robust</h4>
      <div class="imgbox"><img id="stackRobustImg" alt="Robust stack" style="display:none;"></div>
      <div class="stack-links mono muted">
        <a id="robustPngLink" href="#" target="_blank" style="display:none;">PNG</a>
        <span class="sep">·</span>
        <a id="robustFitsLink" href="#" target="_blank" style="display:none;">FITS</a>
      </div>
    </article>
    <article class="stack-card">
      <h4>Anomaly</h4>
      <div class="imgbox"><img id="stackAnomImg" alt="Anomaly map" style="display:none;"></div>
      <div class="stack-links mono muted">
        <a id="anomPngLink" href="#" target="_blank" style="display:none;">PNG</a>
        <span class="sep">·</span>
        <a id="anomFitsLink" href="#" target="_blank" style="display:none;">FITS</a>
      </div>
    </article>
  </div>
</section>

<section>
  <h2>Live Airspace (<span id="allAircraftCount">0</span>)</h2>
  <div style="max-height: 400px; overflow-y: auto;">
    <table>
      <thead>
        <tr>
          <th>ICAO</th>
          <th>Flight</th>
          <th>Altitude (ft)</th>
          <th>Speed (kts)</th>
          <th>Track (°)</th>
          <th>Distance (nm)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="allAircraftTableBody"></tbody>
    </table>
  </div>
</section>
</main>

<script>
const q = sel => document.querySelector(sel);
const has = v => v !== undefined && v !== null;

/* === helpers === */
function fmt(val, dec = 1) {
  if (!has(val)) return '—';
  const num = Number(val);
  if (Number.isNaN(num)) return '—';
  return num.toFixed(dec);
}

function createButtonForm(icao) {
  const form = document.createElement('form');
  form.action = '/command/track';
  form.method = 'post';
  form.style.margin = '0';

  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'icao';
  input.value = icao;
  form.appendChild(input);

  const btn = document.createElement('button');
  btn.type = 'submit';
  btn.textContent = 'Track';
  form.appendChild(btn);

  return form;
}

/* ------------------- Existing dashboard updater ------------------- */
function updateDashboard(s) {
    const isTracking = s.mode && s.mode !== 'idle' && s.mode !== 'initializing';
    q('#abortButton').disabled = !isTracking;

    // Status Panel
    const statusEl = q('#statusText');
    let modeText = s.mode || 'unknown';
    const mode = (s.mode || 'unknown').replace(/\s+/g, '-');
    statusEl.className = `mono status-${mode}`;
    if (s.mode === 'slewing' && s.target_az_el) {
        modeText = `Slewing to ${fmt(s.target_az_el[0])}° Az`;
    } else if (s.mode === 'focusing' && s.autofocus_alt_ft) {
        modeText = `Focusing (Alt: ${fmt(s.autofocus_alt_ft, 0)} ft)`;
    } else if (s.mode === 'tracking' && s.iteration) {
        modeText = `Tracking (Frame: ${s.iteration})`;
    } else if (s.mode === 'acquiring') {
        modeText = 'Acquiring Target...';
    } else if (s.mode === 'idle') {
        modeText = 'Idle - Monitoring';
    }
    statusEl.textContent = modeText;
    q('#targetCoords').textContent = has(s.target_az_el) ? `az ${fmt(s.target_az_el[0])}, el ${fmt(s.target_az_el[1])}` : '—';
    q('#mountCoords').textContent = has(s.mount_az_el) ? `az ${fmt(s.mount_az_el[0])}, el ${fmt(s.mount_az_el[1])}` : '—';
    q('#observerLocation').textContent = has(s.observer_loc) ? `Lat ${fmt(s.observer_loc.lat, 2)}, Lon ${fmt(s.observer_loc.lon, 2)}` : '—';
    q('#updatedAt').textContent = has(s.updated_at) ? new Date(s.updated_at*1000).toLocaleTimeString() : '—';

    // Target Details Panel
    const details = s.target_details || {};
    q('#targetIcao').textContent = s.icao || '—';
    q('#targetFlight').textContent = details.flight ? details.flight.trim() : '—';
    q('#targetAlt').textContent = has(details.alt) ? `${fmt(details.alt, 0)} ft` : '—';
    q('#targetSpeed').textContent = has(details.gs) ? `${fmt(details.gs, 1)} kts` : '—';
    q('#targetTrack').textContent = has(details.track) ? `${fmt(details.track, 1)}°` : '—';
    
    // Camera & Hardware Vitals Panel
    const settings = s.camera_settings || {};
    q('#camSetpoint').textContent = settings.cooling ? `${fmt(settings.cooling.setpoint_c, 1)} °C` : '—';
    q('#camTemp').textContent = has(s.camera_temp) ? `${fmt(s.camera_temp, 1)} °C` : '—';
    q('#coolerPower').textContent = has(s.camera_cooler_power) ? `${fmt(s.camera_cooler_power, 1)} %` : '—';
    q('#camBinning').textContent = s.camera_binning ? `${fmt(s.camera_binning.x, 0)}x${fmt(s.camera_binning.y, 0)}` : '—';
    q('#camGain').textContent = has(s.camera_gain) ? fmt(s.camera_gain, 0) : '—';
    q('#camOffset').textContent = has(s.camera_offset) ? fmt(s.camera_offset, 0) : '—';
    q('#focuserPos').textContent = has(s.focuser_pos) ? fmt(s.focuser_pos, 0) : '—';
    q('#focuserTemp').textContent = has(s.focuser_temp) ? `${fmt(s.focuser_temp, 1)} °C` : '—';
    q('#pierSide').textContent = s.mount_pier_side || '—';
    
    // Live Airspace Table
    const allAircraft = s.all_aircraft || [];
    q('#allAircraftCount').textContent = allAircraft.length;
    const tbody = q('#allAircraftTableBody');
    tbody.innerHTML = '';
    allAircraft.sort((a, b) => (a.dist_nm ?? Infinity) - (b.dist_nm ?? Infinity));
    allAircraft.forEach(ac => {
        const tr = document.createElement('tr');
        if (ac.icao === s.icao) tr.classList.add('tracking-row');
        
        const cells = [
          { text: ac.icao, classes: ['mono'] },
          { text: ac.flight || 'N/A', classes: ['mono'] },
          { text: fmt(ac.alt, 0) },
          { text: fmt(ac.gs, 1) },
          { text: fmt(ac.track, 1) },
          { text: fmt(ac.dist_nm, 1) },
        ];

        cells.forEach(c => {
            const td = document.createElement('td');
            if (c.classes) td.classList.add(...c.classes);
            td.textContent = c.text;
            tr.appendChild(td);
        });

        const actionTd = document.createElement('td');
        actionTd.appendChild(createButtonForm(ac.icao));
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
    });

    // Image Panels (guide)
    const guideEl = q('#guideImg');
    if (s.last_guide_png) {
        guideEl.onload = () => { guideEl.style.display = 'block'; };
        guideEl.onerror = () => { guideEl.style.display = 'none'; };
        guideEl.src = s.last_guide_png + '?t=' + Date.now();
    }
    q('#guideInfo').textContent = s.last_guide_file || '—';
    

    q('#sequenceCount').textContent = s.sequence_count || '—';
    q('#sequenceExp').textContent = has(s.sequence_exposure_s) ? fmt(s.sequence_exposure_s, 3) : '—';
    
    q('#offsetXY').textContent = has(s.guide_offset_px) ? `dx=${fmt(s.guide_offset_px.dx)}, dy=${fmt(s.guide_offset_px.dy)} px` : '—';
}

let lastStackSeqId = null;
let lastImgUrls    = { mean:null, robust:null, anomaly:null };
let lastLinkUrls   = {
  mean:   { png:null, fits:null },
  robust: { png:null, fits:null },
  anomaly:{ png:null, fits:null }
};

function _setImgOnce(el, url) {
  if (!el || !url) return;
  if (el.dataset.urlBase === url) return;              // don't reload if unchanged
  el.dataset.urlBase = url;
  el.onload = () => { el.style.display = 'block'; };
  el.onerror = () => { /* keep last frame visible; do not hide to avoid flicker */ };
  el.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
}

function _setLinkStable(el, newUrl, variant, kind) {
  if (!el) return;
  const prev = lastLinkUrls[variant][kind];
  if (newUrl) {
    el.href = newUrl;
    el.style.display = 'inline';
    lastLinkUrls[variant][kind] = newUrl;
  } else if (prev) {
    // Keep previous valid link visible to avoid flicker
    el.href = prev;
    el.style.display = 'inline';
  } else {
    // No link ever known for this slot -> keep hidden
    el.style.display = 'none';
    el.removeAttribute('href');
  }
}

function renderLatestStackPayload(p) {
  // If payload is empty (or we got a transient 404 earlier), DO NOTHING.
  if (!p || !p.products) return;

  const when = p.timestamp ? new Date(p.timestamp*1000).toLocaleString() : '—';
  q('#stackMeta').textContent = `ICAO ${p.icao} · Seq ${p.sequence_id} · ${when}`;
  const badge = q('#stackBadge');
  badge.textContent = p.icao || '';
  badge.style.display = p.icao ? 'inline-block' : 'none';

  const mean    = p.products.mean    || {};
  const robust  = p.products.robust  || {};
  const anom    = p.products.anomaly || {};

  const meanUrl   = mean.png;
  const robustUrl = robust.png;
  const anomUrl   = anom.png;

  // Images: only change when sequence changed OR URL changed
  if (p.sequence_id !== lastStackSeqId || meanUrl !== lastImgUrls.mean)   _setImgOnce(q('#stackMeanImg'), meanUrl);
  if (p.sequence_id !== lastStackSeqId || robustUrl !== lastImgUrls.robust) _setImgOnce(q('#stackRobustImg'), robustUrl);
  if (p.sequence_id !== lastStackSeqId || anomUrl !== lastImgUrls.anomaly)  _setImgOnce(q('#stackAnomImg'), anomUrl);

  // Links: keep last known non-empty URLs if new payload omits them
  _setLinkStable(q('#meanPngLink'),   mean.png,   'mean',   'png');
  _setLinkStable(q('#meanFitsLink'),  mean.fits,  'mean',   'fits');
  _setLinkStable(q('#robustPngLink'), robust.png, 'robust', 'png');
  _setLinkStable(q('#robustFitsLink'),robust.fits,'robust', 'fits');
  _setLinkStable(q('#anomPngLink'),   anom.png,   'anomaly','png');
  _setLinkStable(q('#anomFitsLink'),  anom.fits,  'anomaly','fits');

  lastStackSeqId = p.sequence_id || lastStackSeqId;
  lastImgUrls = { mean: meanUrl || lastImgUrls.mean, robust: robustUrl || lastImgUrls.robust, anomaly: anomUrl || lastImgUrls.anomaly };
}

function refreshLatestStack(){
  fetch('/api/latest_stack', {cache:'no-store'})
    .then(r => { if (r.status === 404) return null; return r.json(); })
    .then(data => renderLatestStackPayload(data))
    .catch(() => {/* ignore transient errors; keep current images/links */});
}

/* ------------------- Refresh loop ------------------- */
function refresh(){
  fetch('/api/status', {cache:'no-store'}).then(r=>r.json()).then(updateDashboard)
    .catch(()=>{/* Swallow errors during server restarts */});
  refreshLatestStack();
}

refresh();
setInterval(refresh, 2000);
</script>
</body>
</html>

